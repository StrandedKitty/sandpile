<!DOCTYPE html>
<html>
	<head>
		<title>Sandpile</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0;
				overflow: hidden;
				font-family: monospace;
			}
			canvas {
				width: 100%;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script id="2d-vertex-shader" type="x-shader/x-vertex">
		attribute vec2 a_position;
		attribute vec2 a_texCoord;
		uniform vec2 u_resolution;
		varying vec2 v_texCoord;
		void main() {
			 gl_Position = vec4(a_position, 0, 1);
			 v_texCoord = a_texCoord;
		}
		</script>
		<script id="2d-fragment-shader" type="x-shader/x-fragment">
		precision highp float;
		varying vec2 v_texCoord;
		uniform int u_counter;
		uniform sampler2D u_image;
		uniform vec2 u_resolution;
		
		int get(float x, float y) {
			vec2 coord = v_texCoord + vec2(x, y)*(1.0/u_resolution);
			if(coord.x < 0. || coord.x > 1. || coord.y < 0. || coord.y > 1.) return 0;
			else {
				return int(texture2D(u_image, coord).r*255.0) + int(texture2D(u_image, coord).g*255.0)*256 + int(texture2D(u_image, coord).b*255.0)*256*256;
			}
		}
		int mod(int a, int b) {
			return int(float(a) - (float(b) * floor(float(a)/float(b))));
		}
		
		void main() {
			vec2 p = 1.0/u_resolution;
			vec3 color;
			if(u_counter == 0) {
				if(v_texCoord.x > 0.5-p.x && v_texCoord.x < 0.5 && v_texCoord.y > 0.5-p.y && v_texCoord.y < 0.5) color = vec3(1.0, 1.0, 1.0);
				else color = vec3(0.0, 0.0, 0.0);
			} else {
				int h = get(0.0, 0.0);
				int hLeft = get(-1.0, 0.0);
				int hRight = get(1.0, 0.0);
				int hTop = get(0.0, 1.0);
				int hBottom = get(0.0, -1.0);
				
				if(h >= 4) h -= 4;
				if(hLeft >= 4) h += 1;
				if(hRight >= 4) h += 1;
				if(hTop >= 4) h += 1;
				if(hBottom >= 4) h += 1;
				
				color.r = float(mod(mod(h, 256*256), 256))/255.0;
				color.g = float(mod(h, 256*256)/256)/255.0;
				color.b = float(h/(256*256))/255.0;
			}
			gl_FragColor = vec4(color, 1.0);
		}
		</script>
		<script id="final-fragment-shader" type="x-shader/x-fragment">
		precision highp float;
		varying vec2 v_texCoord;
		uniform int u_counter;
		uniform sampler2D u_image;
		uniform vec2 u_resolution;
		uniform vec3 u_color1;
		uniform vec3 u_color2;
		uniform vec3 u_color3;
		uniform vec2 u_size;
		uniform float u_scale;
		
		void main() {
			vec3 color;
			vec2 coord = ((v_texCoord-0.5)*u_scale)*(u_resolution/u_size)+0.5;
			if(coord.x < 0.0 || coord.x > 1.0 || coord.y < 0.0 || coord.y > 1.0) {
				color = vec3(0.98, 0.98, 0.98);
			} else {
				int height = int(texture2D(u_image, coord).r*255.0) + int(texture2D(u_image, coord).g*255.0)*256 + int(texture2D(u_image, coord).b*255.0)*256*256;
				if(height == 0) color = vec3(0.98, 0.98, 0.98);
				if(height == 1) color = u_color1/255.;
				if(height == 2) color = u_color2/255.;
				if(height >= 3) color = u_color3/255.;
			}
			
			gl_FragColor = vec4(color, 1.0);
		}
		</script>
		<script src="https://webglfundamentals.org/webgl/resources/webgl-utils.js"></script>
		<script>
			var canvas = document.getElementById("canvas");
			var width = 513;
			var height = 513;
			var scale = 0.5;
			var dscale = 0.5;
			var paused = false;
			canvas.width = window.innerWidth*window.devicePixelRatio;
			canvas.height = window.innerHeight*window.devicePixelRatio;
			var targetTexture1, targetTexture2;
			var fb1, fb2;
			function main() {
				var gl = canvas.getContext("webgl");
				if (!gl) {
					return;
				}
				var program = webglUtils.createProgramFromScripts(gl, ["2d-vertex-shader", "2d-fragment-shader"]);
				var programFinal = webglUtils.createProgramFromScripts(gl, ["2d-vertex-shader", "final-fragment-shader"]);
				
				gl.useProgram(program);
				
				var positionLocation = gl.getAttribLocation(program, "a_position");
				var texcoordLocation = gl.getAttribLocation(program, "a_texCoord");
				var resolutionLocation = gl.getUniformLocation(program, "u_resolution");
				var imageLocation = gl.getUniformLocation(program, "u_image");
				var counterLocation = gl.getUniformLocation(program, "u_counter");
				gl.uniform2f(resolutionLocation, width, height);
				gl.uniform1i(imageLocation, 0);
				gl.uniform1i(counterLocation, 0);
				
				gl.useProgram(programFinal);
				
				var positionLocationFinal = gl.getAttribLocation(programFinal, "a_position");
				var texcoordLocationFinal = gl.getAttribLocation(programFinal, "a_texCoord");
				var resolutionLocationFinal = gl.getUniformLocation(programFinal, "u_resolution");
				var sizeLocationFinal = gl.getUniformLocation(programFinal, "u_size");
				var imageLocationFinal = gl.getUniformLocation(programFinal, "u_image");
				var scaleLocationFinal = gl.getUniformLocation(programFinal, "u_scale");
				var color1LocationFinal = gl.getUniformLocation(programFinal, "u_color1");
				var color2LocationFinal = gl.getUniformLocation(programFinal, "u_color2");
				var color3LocationFinal = gl.getUniformLocation(programFinal, "u_color3");
				gl.uniform1i(imageLocationFinal, 0);
				gl.uniform2f(resolutionLocationFinal, window.innerWidth*window.devicePixelRatio, window.innerHeight*window.devicePixelRatio);
				gl.uniform2f(sizeLocationFinal, width, height);
				
				gl.uniform3fv(color1LocationFinal, [255, 0, 104]);
				gl.uniform3fv(color2LocationFinal, [0, 234, 139]);
				gl.uniform3fv(color3LocationFinal, [57, 107, 255]);
				
				gl.useProgram(program);
				
				targetTexture1 = gl.createTexture();
				targetTexture2 = gl.createTexture();
				
				gl.bindTexture(gl.TEXTURE_2D, targetTexture1);
				var level = 0;
				var internalFormat = gl.RGBA;
				var border = 0;
				var format = gl.RGBA;
				var type = gl.UNSIGNED_BYTE;
				gl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, null);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
				
				gl.bindTexture(gl.TEXTURE_2D, targetTexture2);
				var level = 0;
				var internalFormat = gl.RGBA;
				var border = 0;
				var format = gl.RGBA;
				var type = gl.UNSIGNED_BYTE;
				gl.texImage2D(gl.TEXTURE_2D, level, internalFormat, width, height, border, format, type, null);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
				
				fb1 = gl.createFramebuffer();
				fb2 = gl.createFramebuffer();
				
				gl.bindFramebuffer(gl.FRAMEBUFFER, fb1);
				var attachmentPoint1 = gl.COLOR_ATTACHMENT0;
				gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint1, gl.TEXTURE_2D, targetTexture1, 0);
				gl.bindFramebuffer(gl.FRAMEBUFFER, null);
				
				gl.bindFramebuffer(gl.FRAMEBUFFER, fb2);
				var attachmentPoint2 = gl.COLOR_ATTACHMENT0;
				gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint2, gl.TEXTURE_2D, targetTexture2, 0);
				gl.bindFramebuffer(gl.FRAMEBUFFER, null);
				
				gl.viewport(0, 0, width, height);
				gl.clearColor(0, 0, 0, 0);
				gl.clear(gl.COLOR_BUFFER_BIT);
				
				var positionBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
				setRectangle(gl, -1, -1, 2, 2);
				
				var texcoordBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
					0.0,	0.0,
					1.0,	0.0,
					0.0,	1.0,
					0.0,	1.0,
					1.0,	0.0,
					1.0,	1.0,
				]), gl.STATIC_DRAW);
				
				gl.enableVertexAttribArray(positionLocation);
				
				gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
				var size = 2;
				var type = gl.FLOAT;
				var normalize = false;
				var stride = 0;
				var offset = 0;
				gl.vertexAttribPointer(positionLocation, size, type, normalize, stride, offset);
				gl.enableVertexAttribArray(texcoordLocation);
				
				gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);
				var size = 2;
				var type = gl.FLOAT;
				var normalize = false;
				var stride = 0;
				var offset = 0;
				gl.vertexAttribPointer(texcoordLocation, size, type, normalize, stride, offset);
				
				gl.useProgram(programFinal);
				
				var positionBufferFinal = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, positionBufferFinal);
				setRectangle(gl, -1, -1, 2, 2);
				
				var texcoordBufferFinal = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBufferFinal);
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
					0.0,	0.0,
					1.0,	0.0,
					0.0,	1.0,
					0.0,	1.0,
					1.0,	0.0,
					1.0,	1.0,
				]), gl.STATIC_DRAW);
				
				gl.enableVertexAttribArray(positionLocationFinal);
				
				gl.bindBuffer(gl.ARRAY_BUFFER, positionBufferFinal);
				var size = 2;
				var type = gl.FLOAT;
				var normalize = false;
				var stride = 0;
				var offset = 0;
				gl.vertexAttribPointer(positionLocationFinal, size, type, normalize, stride, offset);
				gl.enableVertexAttribArray(texcoordLocationFinal);
				
				gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBufferFinal);
				var size = 2;
				var type = gl.FLOAT;
				var normalize = false;
				var stride = 0;
				var offset = 0;
				gl.vertexAttribPointer(texcoordLocationFinal, size, type, normalize, stride, offset);
				
				gl.useProgram(program);
				
				draw();
				var counter = 0;
				var lastTime = 0;
				function draw(time){
					requestAnimationFrame(draw);
					
					gl.viewport(0, 0, width, height);
					
					scale += (dscale - scale)*0.5;

					if(!paused) {
						for(var i=0; i<20; i++) {
							gl.uniform1i(counterLocation, counter);
							
							gl.activeTexture(gl.TEXTURE0);
							gl.bindTexture(gl.TEXTURE_2D, counter%2 ? targetTexture1 : targetTexture2);
							
							gl.bindFramebuffer(gl.FRAMEBUFFER, counter%2 ? fb2 : fb1);
							gl.drawArrays(gl.TRIANGLES, 0, 6);
							
							counter++;
						}
					}
					
					
					
					gl.useProgram(programFinal);
					gl.useProgram(programFinal);
					gl.viewport(0, 0, window.innerWidth*window.devicePixelRatio, window.innerHeight*window.devicePixelRatio);
					gl.uniform2f(resolutionLocationFinal, window.innerWidth*window.devicePixelRatio, window.innerHeight*window.devicePixelRatio);
					gl.uniform1f(scaleLocationFinal, scale);
					gl.activeTexture(gl.TEXTURE0);
					gl.bindTexture(gl.TEXTURE_2D, counter%2 ? targetTexture1 : targetTexture2);
					gl.bindFramebuffer(gl.FRAMEBUFFER, null);
					gl.drawArrays(gl.TRIANGLES, 0, 6);
					gl.useProgram(program);
					
					//console.log(time - lastTime);
					lastTime = time;
				}
				
				window.addEventListener('resize', function(){
					
					canvas.width = window.innerWidth*window.devicePixelRatio;
					canvas.height = window.innerHeight*window.devicePixelRatio;
				});
				canvas.addEventListener("wheel", function(e){
					if(e.deltaY < 0) dscale *= 0.9;
					if(e.deltaY > 0) dscale *= 1.1;
				});
				document.body.onkeydown = function(e){
					if(e.keyCode == 32){
						paused = !paused;
					}
				}
			}
			
			function setRectangle(gl, x, y, width, height) {
				var x1 = x;
				var x2 = x + width;
				var y1 = y;
				var y2 = y + height;
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
				 x1, y1,
				 x2, y1,
				 x1, y2,
				 x1, y2,
				 x2, y1,
				 x2, y2,
				]), gl.STATIC_DRAW);
			}
			main();
		</script>
	</body>
</html>